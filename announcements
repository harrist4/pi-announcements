#!/bin/bash
# Helper for the Raspberry Pi Announcements Frame
fn=$(basename "$0")

SERVICES=(
  announcements-watcher
  announcements-slideshow
  announcements-display
  announcements-status
)

BASE_DIR="/srv/announcements"
INBOX_DIR="$BASE_DIR/inbox"
LIVE_DIR="$BASE_DIR/live"
OFF_DIR="$BASE_DIR/off"
CONF_FILE="$BASE_DIR/config/announcements.conf"
LOG_DIR="$BASE_DIR/logs"
TMP_DIR="$BASE_DIR/tmp"

SRC_DIR="/srv/announcements-src"
INSTALL_INFO="$BASE_DIR/INSTALL_INFO"

SLIDES_MODE_FILE="/tmp/announcements_slides_mode"

# Don't run this helper as root; it will sudo where needed.
if [[ $EUID -eq 0 ]]; then
  echo "Do not run this helper as root; it will sudo individual commands as needed."
  exit 1
fi

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
RESET=$(tput sgr0)

usage() {
  cat <<EOF
Usage: $fn {status|services|smb|config|start|stop|restart|logs|summary|test|paths|version|off|help}

  status     Show brief runtime status (slides, counts, service activity)
  services   Show detailed systemd service status
  smb        Show Samba service/share status
  config     Edit the config file using \$EDITOR or nano

  start      Start all announcements services
  stop       Stop all announcements services
  restart    Restart all announcements services
  logs       Show recent logs for all announcements services

  summary    One-line summary of system state
  test       Structural install health check
  paths      Show key directories and state files
  version    Show installed version info
  off        Force “black screen” mode
  help       Show this help

Notes:
  Use "$fn paths" to see key directories and state files.
  To uninstall, run: sudo /srv/announcements-src/uninstall.sh
EOF
}

do_services() {
  local action="$1"
  for s in "${SERVICES[@]}"; do
    echo "--- $action $s.service ---"
    sudo systemctl "$action" "$s.service"
  done
}

do_status() {
  echo "=== Announcements Status ==="

  echo -n "Slides mode: "
  [[ -f "$SLIDES_MODE_FILE" ]] && cat "$SLIDES_MODE_FILE" || echo "(auto)"
  echo

  live_count=$(find "$LIVE_DIR" -maxdepth 1 -type f 2>/dev/null | wc -l | tr -d ' ')
  inbox_count=$(find "$INBOX_DIR" -maxdepth 1 -type f ! -name '*.txt' 2>/dev/null | wc -l | tr -d ' ')
  tmp_count=$(find "$TMP_DIR" -maxdepth 1 -type f 2>/dev/null | wc -l | tr -d ' ')
  echo "Live: $live_count    Inbox: $inbox_count    Temp: $tmp_count"
  echo

  echo "Services:"
  for s in "${SERVICES[@]}"; do
    if systemctl is-active --quiet "$s.service" 2>/dev/null; then
      st="active"
    else
      st="inactive"
    fi
    [[ "$st" = active ]] && col=$GREEN || col=$RED
    echo "  $s: ${col}$st${RESET}"
  done
}

do_services_status() {
  for s in "${SERVICES[@]}"; do
    echo "=== $s.service ==="
    sudo systemctl status "$s.service" --no-pager --lines=4 || true
    echo
  done
}

do_smb() {
  echo "=== Samba ==="
  if systemctl is-active --quiet smbd.service; then
    echo "  smbd: ${GREEN}active${RESET}"
  else
    echo "  smbd: ${RED}inactive${RESET}"
  fi
  echo

  echo "Shares:"
  grep -E '^\[.*\]' /etc/samba/smb.conf | grep -v '\[global\]' |
  while read -r sec; do
    share=$(echo "$sec" | tr -d '[]')
    path=$(awk -v s="[$share]" '
      $0==s {found=1; next}
      /^\[/ && found {found=0}
      found && $1=="path" {print $3; exit}
    ' /etc/samba/smb.conf)
    [[ -z "$path" ]] && echo "  $share → (no path)" && continue
    [[ -d "$path" ]] && echo "  $share → $path (OK)" || echo "  $share → $path (MISSING)"
  done
}

do_config() {
  editor="${EDITOR:-nano}"
  command -v "$editor" >/dev/null 2>&1 || editor=nano
  "$editor" "$CONF_FILE"
}

do_logs() {
  local lines="${1:-50}"
  for s in "${SERVICES[@]}"; do
    echo "=== journal: $s.service (last $lines lines) ==="
    sudo journalctl -u "$s.service" --no-pager -n "$lines" || true
    echo
  done
}

do_test() {
  echo "== Directory layout =="
  for d in "$BASE_DIR" "$LIVE_DIR" "$INBOX_DIR" "$TMP_DIR"; do
    [[ -d "$d" ]] && echo "  OK: $d" || echo "  FAIL: $d missing"
  done
  echo
  echo "== Config =="
  [[ -f "$CONF_FILE" ]] && echo "  OK: $CONF_FILE" || echo "  FAIL: config missing"

  echo
  echo "== Service installation =="
  for s in "${SERVICES[@]}"; do
    if systemctl is-enabled --quiet "$s.service" 2>/dev/null; then
      echo "  $s.service: enabled"
    else
      echo "  $s.service: disabled"
    fi
  done

  echo
  echo "== Samba shares =="
  do_smb
}

do_version() {
  echo "== Version =="
  if [ -f "$SRC_DIR/VERSION" ]; then
    echo -n "  Announcements Frame: "
    cat "$SRC_DIR/VERSION"
  else
    echo "  Version file not found at $SRC_DIR/VERSION"
  fi

  if [ -f "$INSTALL_INFO" ]; then
    echo
    echo "== Install info =="
    sed 's/^/  /' "$INSTALL_INFO"
  fi
}

do_summary() {
  echo "=== Announcements Frame Summary ==="
  if [ -f "$SRC_DIR/VERSION" ]; then
    echo -n "Version: "
    cat "$SRC_DIR/VERSION"
  else
    echo "Version: (unknown)"
  fi

  if [ -f "$INSTALL_INFO" ]; then
    echo "Install info:"
    sed 's/^/  /' "$INSTALL_INFO"
  fi

  echo
  if [ -d "$LIVE_DIR" ]; then
    local live_count
    live_count=$(find "$LIVE_DIR" -maxdepth 1 -type f 2>/dev/null | wc -l | tr -d ' ')
    echo "Live slides dir: $LIVE_DIR ($live_count files)"
  else
    echo "Live slides dir: $LIVE_DIR (missing)"
  fi

  echo "Inbox dir:      $INBOX_DIR"
  echo
  echo "Services:"
  for s in "${SERVICES[@]}"; do
    if systemctl is-active --quiet "$s.service" 2>/dev/null; then
      state="active"
    else
      state="inactive"
    fi
    echo "  $s.service: $state"
  done
}

do_paths() {
  cat <<EOF
== Paths ==
Base dir:          $BASE_DIR
Inbox (upload):    $INBOX_DIR
Live slides:       $LIVE_DIR
Off-schedule:      $OFF_DIR
Config:            $CONF_FILE
Logs:              $LOG_DIR
Temp:              $TMP_DIR

Slides mode file:      $SLIDES_MODE_FILE

Source tree (scripts, VERSION, uninstall):
  $SRC_DIR
EOF
}

do_off() {
  echo "Forcing slideshow into 'off' (black screen) mode..."
  echo "off" | sudo tee "$SLIDES_MODE_FILE" >/dev/null || {
    echo "Failed to write $SLIDES_MODE_FILE" >&2
    return 1
  }
  echo "Restarting slideshow service..."
  sudo systemctl restart announcements-slideshow.service || true
  echo "Done. Slideshow will switch to black on next refresh."
}

cmd="${1:-help}"

case "$cmd" in
  services)
    do_services_status
    ;;

  smb)
    do_smb
    ;;

  config)
    do_config
    ;;
  status)
    do_status
    ;;
  start|stop|restart)
    do_services "$cmd"
    ;;
  logs)
    do_logs "${1:-50}"
    ;;
  test)
    do_test
    ;;
  version)
    do_version
    ;;
  summary)
    do_summary
    ;;
  paths)
    do_paths
    ;;
  off)
    do_off
    ;;
  help|-h|--help|"")
    usage
    ;;
  *)
    echo "Unknown command: $cmd"
    echo
    usage
    exit 1
    ;;
esac
